<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script type="module" src="https://cdn.space.unibe.ch/JsonToHtml.js"></script>

<script src="https://cdn.space.unibe.ch/Fontawesome.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">

<ul id="midi-list"></ul>
<div id="debug"></div>
<div id="app">

</div>

<style>
*{
    margin:0;
    padding:0;
}
body::-webkit-scrollbar {
    display: none;
}
body{
    background:#0d0c08;
    color:#eee;
    min-width: 100vw;
    min-height: 100vh;
}
h1,h2,h3,h4,h5,h6{
    color:#eee !important;
}
#midi_stuff{
    position: absolute;
    top: 0.6%;
    left: 16%;
    width: 48%;
    /* padding: 0; */
    height: 8%;
    /* margin: 0; */
    display: flex;
}

#midi_debugger {
    position: relative;
    border: 1px solid #51ef00;
    width: 19%;
    height: 7%;
    z-index: 1;
    font-size: 0.8rem;
    overflow-y: scroll;
    height: 100%;
    width:50%;
}
#midi_devices{
    z-index: 2;
}
/* width */
#midi_debugger::-webkit-scrollbar {
  width: 0.5rem;
}

/* Track */
#midi_debugger::-webkit-scrollbar-thumb {
  background: #33990069;
}
/* Track hover*/
#midi_debugger::-webkit-scrollbar-thumb:hover {
  background: #339900;
}
/* Handle */
#midi_debugger::-webkit-scrollbar-track {
  background: #0c2500;
}

#midi_debugger > div{
     display: flex; 
    flex-direction: column;
}
#midi_debugger .msg { 
    color: #51ef00;
}
#midi_debugger .ts{
    color: #297904; 
}
#app, .content {
    display: flex;
    align-items: center;
    justify-content: center;
}
canvas{
    position: fixed;
    z-index: 0;
    width: 100%;
    height: 100%;
}
.inputs{
    background: rgba(0,0,0.8);
    position: fixed;
    z-index: 1;
}
.img_container{
    position: relative;
    position: relative;
    background: black;
}
img{
    max-height: 100vh;
}
.akai_apc_mini{
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-size: contain;
    background-repeat: no-repeat;
}
ul#midi-list {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 10;
    background: black;
    padding: 1rem;
}
.pads_groups{
    display: flex;
    flex-direction: column-reverse;

}
.pad_group{
    display: flex;
    flex-direction: row;

}
.pad {
    width: 9.2%;
    /* height: 100; */
    background: rgba(222,222,222,0.5);
    margin-right: 1.9%;
    /* border: solid red; */
    padding-top: 4.1%;
    margin-bottom: 1.9%;
    border-radius: 8px;
    position: relative;
}

.pad_inner{
    position: absolute;
    top: 0;
    left: 0;
    width:100%;
    height: 100%;
    word-break: break-all;
    font-size: 10px;
    color: black;
    padding:0.5rem;
    justify-content: center;
    align-items: center;
    /* border-radius: 2px; */
}

.pads_groups {
    margin-left: 1.9%;
    margin-top: 7.7%;
}
.pad.keydown_true{
    background:red !important;
}
.faders {
    background: rgb(234 21 186 / 20%);
}

.fader {
    position: absolute;
    background: rgba(222,0,0,0.1);
    /* margin-right: 3.4%; */
    z-index: 10;
    border: 1px solid red;
}
.fader_inner {
    width: 100%;
    background: red;
    position: absolute;
    bottom: 10%;
    height:10px;
}


.fader_button {
    position: absolute;
    border-radius: 50%;
    background: rgba(222,0,0,0.1);
    z-index: 10;
    border: 1px solid blue;
}


.scene_button {
    position: absolute;
    border-radius: 50%;
    background: rgba(222,0,0,0.1);
    z-index: 10;
    border: 1px solid red;
}


.shift_button {
    position: absolute;
    border-radius: 5px;
    background: rgba(222,0,0,0.1);
    z-index: 10;
    border: 1px solid pink;
}

.main_button {
    position: absolute;
    border-radius: 10px;
    background: rgba(70, 230, 49, 0.1);
    z-index: 10;
    border: 1px solid yellow;
}

</style>

<script type="text/javascript">

    document.addEventListener("DOMContentLoaded", function () {

        document.getElementById("app").append(
            jth.parse(
                {
                    t:"div",
                    class: "content", 
                    c: [

                        {
                            id: "audio", 
                            t: "audio"
                        },

                        {
                            t: "div",
                            class: "img_container", 
                            c: [
                                {
                                    "id":"midi_stuff", 
                                    "c": [
                                        {
                                        id: "midi_debugger", 
                                            c: [
                                                {
                                                    "v-for": "msg in midi.debugger.msgs", 
                                                    "v-html": "msg"
                                                }
                                            ]
                                        },
                                        {
                                            id: "midi_devices",  
                                            c: [
                                                {
                                                    "t": "select",
                                                    "v-model": "midi.input_id",
                                                    "v-on:change": "update_midi_input_by_id(midi.input_id)",
                                                    "c": [
                                                        {
                                                            "v-for": "midi_input in midi.inputs",
                                                            "t": "option",
                                                            "v-html": "`${midi_input.manufacturer} - ${midi_input.name}`",
                                                            ":value": "midi_input.id",
                                                            // "v-on:click":"midi.input = midi_input",
                                                            // "v-on:click":"update_midi_input_by_id(midi_input.id)",
                                                            // "v-on:click":"alert('asdf')",
                                                        }
                                                    ]
                                                }
                                            ]
                                        },
                                    ]
                                },
                                {
                                    src:"akai_apc_mini_nobuttons_noborder.png", 
                                    t:"img"
                                },
                                {
                                    "class": "akai_apc_mini",
                                    c:[
                                        
                                        {
                                            class: "main_buttons",
                                            c:[
                                                {
                                                    "class":"main_button",
                                                    "v-for": "main_button in akai_apc_mini.main_buttons.objects",
                                                    ":style": "get_button_style(main_button, akai_apc_mini.main_buttons.position)",
                                                }
                                            ]
                                        },
                                        {
                                            class: "scene_buttons",
                                            c:[
                                                {
                                                    "class":"scene_button",
                                                    "v-for": "scene_button in akai_apc_mini.scene_buttons.objects",
                                                    ":style": "get_button_style(scene_button, akai_apc_mini.scene_buttons.position)",
                                                }
                                            ]
                                        },
                                        {
                                            class: "fader_buttons",
                                            c:[
                                                {
                                                    "class":"fader_button",
                                                    "v-for": "fader_button in akai_apc_mini.fader_buttons.objects",
                                                    ":style": "get_button_style(fader_button, akai_apc_mini.fader_buttons.position)",
                                                }
                                            ]
                                        },
                                        {
                                            class: "faders",
                                            c:[
                                                {
                                                    "class":"fader",
                                                    ":style": "get_button_style(fader, akai_apc_mini.faders.position)",
                                                    "v-for": "fader in akai_apc_mini.faders.objects",
                                                    c:[
                                                        {
                                                            "class": "fader_inner",
                                                            ":style": "`bottom:${akai_apc_mini.fader_min_perc+fader.value_percentage}%`",
                                                            c: [
                                                                {
                                                                    class: "fader_inner2", 
                                                                    "v-html":"fader.value8bit",
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        },

                                        {
                                            "class":"shift_button",
                                            "v-for": "shift_button in akai_apc_mini.shift_button.objects",
                                            ":style": "get_button_style(shift_button, akai_apc_mini.shift_button.position)",
                                        }


                                    ]
                                },   
                            ],
                            "v-on:click": "bool = !bool"
                        }
                    ]
                }, 
            )
        );

        // generate pads groups
        // var rows = 8; 
        // var cols = 8; 
        // var pads_groups =[];
        // for(var i = 0; i < rows; i++){
        //     var pad_group = {pads:[]}
        //     pad_group.name = `pads_${i}_${(i*cols)+(cols-1)}`; 
        //     for(var j = 0; j < cols; j++){
        //         var pad = {
        //             id: (i*cols) + j
        //         }
        //         pad_group.pads.push(pad)
        //     }
        //     pads_groups.push(pad_group)
        // }
        // console.log(JSON.stringify(pads_groups))

            window.vueObject = new Vue({
                el: '#app',
                data: {
                    development: true, 
                    bool: false,
                    midi: {
                        input_id: 0, 
                        access: null,
                        inputs: [], 
                        input: {},
                        outputs: [],
                        output: {},
                        debugger: {
                            msg: "",
                            msgs: [''],
                        } 
                    },
                    last_clicked_pad : {},
                    akai_apc_mini: {
                        midi_messages_send:{
                            button:{

                                status_byte:{
                                    light_on: 0b10010000, 
                                    light_off: 0b10000000, 
                                }, 
                                data_byte1: "please_use_an_integer_of_the_padnumber0_to63", 
                                data_byte2:{
                                    green:1, 
                                    green_blinking: 2, 
                                    red:3, 
                                    red_blinking: 4, 
                                    orange:5, 
                                    orange_blinking: 6
                                }
                                


                            }
                        },
                        hardware_objects: {
                            types: ["button", "fader", "knob"], 
                            objects:[
                                { type: "button", name: "main_button", id: 0, keydown: false, midi_in:[0,0,0], midi_out:[0,0,0]},
                            ]

                        },
                        slider_min_perc : 10,
                        slider_max_perc : 85,
                        faders: {
                            position:{
                                "n_start_id": 48,
                                "n_start_x_perc": 2.5,
                                "n_start_y_perc": 74.3,
                                "n_width_perc": 8.1,
                                "n_height_perc": 20.8,
                                "s_direction_axis": "x",
                                "n_margin_x": 10.85,
                                "n_margin_y": 0
                            },
                            objects: [
                                {"value_u8_bit": 0, value_percentage : 0, id: 48},
                                {"value_u8_bit": 0, value_percentage : 0, id: 49},
                                {"value_u8_bit": 0, value_percentage : 0, id: 50},
                                {"value_u8_bit": 0, value_percentage : 0, id: 51},
                                {"value_u8_bit": 0, value_percentage : 0, id: 52},
                                {"value_u8_bit": 0, value_percentage : 0, id: 53},
                                {"value_u8_bit": 0, value_percentage : 0, id: 54},
                                {"value_u8_bit": 0, value_percentage : 0, id: 55},
                                {"value_u8_bit": 0, value_percentage : 0, id: 56},
                            ]
                        },
                        scene_buttons: {
                            position:{
                                "n_start_id": 82,
                                "n_start_x_perc": 91.7,
                                "n_start_y_perc": 9.1,
                                "n_width_perc": 3.88,
                                "n_height_perc": 3.88,
                                "s_direction_axis": "x",
                                "n_margin_x": -0.01,
                                "n_margin_y": 7.03
                            },
                            objects: [
                                {"keydown": false, "light_color_index" : 0, id: 82 },
                                {"keydown": false, "light_color_index" : 0, id: 83 },
                                {"keydown": false, "light_color_index" : 0, id: 84 },
                                {"keydown": false, "light_color_index" : 0, id: 85 },
                                {"keydown": false, "light_color_index" : 0, id: 86 },
                                {"keydown": false, "light_color_index" : 0, id: 87 },
                                {"keydown": false, "light_color_index" : 0, id: 88 },
                                {"keydown": false, "light_color_index" : 0, id: 89 },
                            ]
                        },
                        fader_buttons:{
                            position:{
                                "n_start_id": 64,
                                "n_start_x_perc": 4.42,
                                "n_start_y_perc": 66,
                                "n_width_perc": 4,
                                "n_height_perc": 4,
                                "s_direction_axis": "x",
                                "n_margin_x": 10.89,
                                "n_margin_y": -0.03
                            },
                            objects:[
                                {"keydown": false, "light_color_index" : 0, id: 64},
                                {"keydown": false, "light_color_index" : 0, id: 65},
                                {"keydown": false, "light_color_index" : 0, id: 66},
                                {"keydown": false, "light_color_index" : 0, id: 67},
                                {"keydown": false, "light_color_index" : 0, id: 68},
                                {"keydown": false, "light_color_index" : 0, id: 69},
                                {"keydown": false, "light_color_index" : 0, id: 70},
                                {"keydown": false, "light_color_index" : 0, id: 71},
                            ]
                        },
                        shift_button:{
                            position:{
                                "n_start_id": 98,
                                "n_start_x_perc": 91.4,
                                "n_start_y_perc": 65.4,
                                "n_width_perc": 4.4,
                                "n_height_perc": 4.4,
                                "s_direction_axis": "x",
                                "n_margin_x": 0,
                                "n_margin_y": 0
                            },
                            objects:[
                                {"keydown": false, "light_color_index" : 0, id: 98},
                            ]
                        },
                        main_buttons:{
                            position:{
                                "n_start_id": 0,
                                "n_start_x_perc": 1.9,
                                "n_start_y_perc": 9.2,
                                "n_width_perc": 9,
                                "n_height_perc": 3.9,
                                "s_direction_axis": "x",
                                "n_margin_x": 10.9,
                                "n_margin_y": 0, 
                                wrap_after: 8, 
                                n_margin_x_after_wrap: 0,
                                n_margin_y_after_wrap: 7.02, 
                            },
                            objects:[{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":0},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":1},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":2},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":3},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":4},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":5},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":6},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":7},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":8},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":9},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":10},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":11},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":12},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":13},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":14},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":15},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":16},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":17},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":18},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":19},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":20},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":21},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":22},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":23},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":24},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":25},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":26},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":27},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":28},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":29},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":30},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":31},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":32},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":33},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":34},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":35},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":36},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":37},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":38},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":39},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":40},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":41},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":42},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":43},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":44},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":45},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":46},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":47},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":48},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":49},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":50},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":51},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":52},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":53},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":54},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":55},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":56},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":57},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":58},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":59},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":60},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":61},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":62},{"keydown":false,"light_color_index":0,"file_name":"click to select file","src":"","id":63}]
                        },
                    },
                    arr: [
                        {
                            "val": 1,
                        },
                        {
                            "val": 2,
                        },
                        {
                            "val": 3,
                        },
                        {
                            "val": 4,
                        }
                    ],
                    url_b64_separator: "#",
                    url_b64_prop: "b64_json", 
                    url_b64_assignment_character: "=", 
                    undo_redo_used : false, 
                    data_to_b64_ignore_props: [
                        "gl", 
                        "overlay_canvas", 
                        "image", 
                        "data_history",
                        "data_history_index",
                        "uniform4fv_rgba_intensity_location", 
                        "reset_history"
                    ], 
                    reset_history: false, 
                    data_history: [

                    ],
                    data_history_index: 0, 
                    data_change : false, 

                },
                updated: function(){
                    
                    //disabled for performance, 29.01.2022

                    // console.log("updated");

                    // var self = this;

                    // self.data_change = true;

                    // self.write_b64_to_url();
                                    
                },
                mounted: function () {



                    var self = this;


                    this.read_b64_from_url();

                    //add first b64 to history
                    // disabled 29.01.2022
                    //this.reset_or_update_history_if_data_change();
                    //console.warn("!IMPORTANT: you are using write_b64_to_url, please set .development to true, to prevent unexpected behaviour in development, since vue _data will be stored and loaded from url")
                    // window.onmouseup = function(){
                    //     //console.log(self.data_change);
                    //     self.reset_or_update_history_if_data_change();
                    // }
                    // window.onkeyup = function(){
                    //     self.reset_or_update_history_if_data_change();
                    // }

                    window.onkeyup = function(event) {

                        // if ctrl + z
                        if(event.ctrlKey && event.which == 90){
                            // if ctrl + shift + z
                            if(event.shiftKey){
                                if(self.data_history_index < self.data_history.length-1){
                                    self.data_history_index++;
                                }
                            }
                            // if only ctrl + z
                            if(!event.shiftKey){
                                if(self.data_history.length > 1 && self.data_history_index > 0){
                                    self.data_history_index--;
                                }
                            }

                            self.undo_redo_used = true;
                            var b64_string = self.data_history[self.data_history_index];
                            var data = self.b64_to_data(b64_string);
                            self.apply_data_copy_to_data(data);
                            
                        }
                    }

                    var audio = document.getElementById("audio");
                    self.midi.access = null;  // global MIDIAccess object

                    try {
                        function on_midi_success( midi_access ) {
                            // self.midi.debugger.msg = window.performance.now().toString();
                            self.midi.debugger.msg = "MIDI ready, plug your device";
                            self.midi.access  = midi_access;
                            self.update_midi_io();

                            self.midi.access.onstatechange = function(e) {

                                self.midi.debugger.msg = window.performance.now().toString();
                                self.midi.debugger.msg = "Device was un/plugged";
                                self.midi.debugger.msg = "Available devices are:";

                                self.update_midi_io();
                                self.midi.access.inputs.forEach(a => self.midi.debugger.msg = a.name);

                                //replaceElements(Array.from(this.inputs.values()));
                            }
                        }
                        function on_midi_failure(msg) {
                            self.midi.debugger.msg = ("Failed to get MIDI access - " + msg);
                        }

                        navigator.requestMIDIAccess().then( on_midi_success, on_midi_failure );
                    } catch (error) {
                        self.midi.debugger.msg = "your browser is not supported :( , please use chrome !"
                    }



                },
                watch: {
                    "midi.input":function(new_val, old_val){
                        console.log('asfd');
                        console.log(new_val);
                        new_val.onmidimessage = this.onmidimessage;
                    },
                    "midi.debugger.msg":{
                        deep: true, 
                        handler: function(new_val, old_val){
                            console.log('asdf');
                            var ts = new Date(); 
                            var s = `${ts.getHours().toString().padStart(2,'0')}:${ts.getMinutes().toString().padStart(2,'0')}:${ts.getSeconds().toString().padStart(2,'0')}`
                            var o = {
                                ts : Date.now(), 
                                msg: `<div class='ts'>${s}:</div> <div class='msg'>${new_val}</div>`
                            }
                            
                            this.midi.debugger.msgs.push(o.msg);
                            console.log(new_val);
                            window.setTimeout(function(){
                                var el= document.querySelector("#midi_debugger");
                                el.scrollTop = el.scrollHeight  
                            },10)
                        }, 
                    },
                    "last_clicked_pad": function(last_clicked_pad_newval, last_clicked_pad_oldval){
                        var self = this;
                        var input = document.createElement('input');
                        input.type = 'file';
                        input.multiple = true;
                        input.addEventListener("change", handleFiles, false);
                        function handleFiles() {
                            for(var i = 0; i < this.files.length; i++){
                            let file = this.files[i];

                                
                            let pad = self.get_object_by_id(i);
                            
                            //console.log(val);
                            //console.log(file);
                            var obj_url = URL.createObjectURL(file);
                            
                            
                            // check for file
                            if(file == undefined) {
                                // Stop the process and tell user they need to upload a file.
                                return false;
                            }

                            let reader1 = new FileReader();
                            reader1.onload = function(ev) {

                                pad.audio_context = new AudioContext()
                                // Decode audio
                                pad.audio_context.decodeAudioData(ev.target.result).then(function(buffer) {
                                    
                                    
                                    pad.buffer = buffer; 


                                });
                            };
                            reader1.readAsArrayBuffer(file);

                            pad.file_name = file.name
                            //last_clicked_pad_newval.obj_url = obj_url;
                            }

                        }

                        input.click(); 
                        console.log(1);
                    },
                    "data": {
                        handler: function(a,b,c,d){
                            console.log(a,b,c,d);
                        },
                        deep: true, 
                    }
                },
                methods: {
                    "update_midi_input_by_id": function(id){
                        var self = this; 
                        // self.midi.inputs.forEach(asdf=> {if(asdf.id == id){self.midi.input = asdf}});
                        self.midi.inputs.forEach(function(asdf){ 
                            console.log(asdf)
                            if(asdf.id == id){
                                self.midi.input = asdf
                            }
                        });
                    },
                    "onmidimessage" : function(m) {
                        var self = this; 
                        self.midi.debugger.msg = m.toString();
                        
                        const [command, key, velocity] = m.data;

                        var command_keynumber = key; 
                            var command_keydown = 144; 
                            var command_keyup = 128;
                            
                            console.log(slider)
                            console.log(command, key, velocity);
                            var pad = vueObject.get_object_by_id(key);
                            var slider = vueObject.get_slider_by_id(key);

                            if(slider){
                                slider.value_percentage = ((vueObject.akai_apc_mini.slider_max_perc - vueObject.akai_apc_mini.slider_min_perc) / 128 )*velocity;
                            }

                            var status_byte = vueObject.akai_apc_mini.midi_messages_send.pad.status_byte.light_off; 
                            var data_byte1 = pad.id; //
                            var data_byte2 = vueObject.akai_apc_mini.midi_messages_send.pad.data_byte2.green; 


                            if(pad){
                                if (command === command_keydown) {
                                    pad.keydown = true;

                                    var pad_light_color_index_max = 3;
                                    pad.light_color_index = (pad.light_color_index+1)%pad_light_color_index_max; 
                                    
                                    if(pad.light_color_index == 0){data_byte2 = vueObject.akai_apc_mini.midi_messages_send.pad.data_byte2.green}
                                    if(pad.light_color_index == 1){data_byte2 = vueObject.akai_apc_mini.midi_messages_send.pad.data_byte2.orange}
                                    if(pad.light_color_index == 2){data_byte2 = vueObject.akai_apc_mini.midi_messages_send.pad.data_byte2.red}
                                
                                    status_byte = vueObject.akai_apc_mini.midi_messages_send.pad.status_byte.light_on;

                                    
                                    if(pad.buffer){
                                        // audio.addEventListener("load", () => {
                                            //     URL.revokeObjectURL(urlObj);
                                            // });
                                            // audio.pause();
                                            // audio.currentTime = 0;
                                            
                                            // audio.src = pad.obj_url;
                                            // audio.play()
                                            // pad.sound_source.stop()
                                            //console.log(self.sound_source);
                                            pad.sound_source = pad.audio_context.createBufferSource();
                                            pad.sound_source.buffer = pad.buffer;
                                            // pad.sound_source.disconnect();

                                            pad.sound_source.connect(pad.audio_context.destination);
                                            // set the value of the pitch here
                                            console.log(pad.id%self.akai_apc_mini.sliders.length)
                                            var pitch = (self.akai_apc_mini.sliders[(pad.id%self.akai_apc_mini.sliders.length-2)].value_percentage/100)*1000;// value of pitch
                                             console.log("pitch")
                                             console.log(pitch)

                                            pad.sound_source.detune.value = pitch;
                                            pad.sound_source.start(0);
                                            //console.log(file);
                                        }
                                        
                                    } else if(command === command_keyup) {
                                        pad.keydown = false;
                                        status_byte = vueObject.akai_apc_mini.midi_messages_send.pad.status_byte.light_off;
                                    }

                                    var midi_message = [status_byte, data_byte1, data_byte2];
                                    window.navigator_midi_output.send(midi_message);
                                }
                    },
                    update_midi_io: function(){
                        var self = this;
                        self.midi.inputs = Array.from(self.midi.access.inputs.values()); 
                        self.midi.outputs = Array.from(self.midi.access.outputs.values()); 
                    },
                    get_button_style: function(object, position){
                        // debugger;
                        var n_width_perc = (object.n_width_perc) ? object.n_width_perc : position.n_width_perc;
                        var n_height_perc = (object.n_height_perc) ? object.n_height_perc : position.n_height_perc;
                        var n_start_x_perc = (object.n_start_x_perc) ? object.n_start_x_perc : position.n_start_x_perc;
                        var n_start_y_perc = (object.n_start_y_perc) ? object.n_start_y_perc : position.n_start_y_perc;
                        var n_margin_x = (object.n_margin_x) ? object.n_margin_x : position.n_margin_x;
                        var n_margin_y = (object.n_margin_y) ? object.n_margin_y : position.n_margin_y;
                        
                        var n_nth_obj = Math.abs(position.n_start_id - object.id);
                        if(position.wrap_after && position.wrap_after != 0){
                            var n_number_of_wraps = parseInt(n_nth_obj / position.wrap_after)
                            var calculated_left_perc = position.n_start_x_perc + (n_nth_obj%position.wrap_after) * (n_margin_x) + n_number_of_wraps * position.n_margin_x_after_wrap; 
                            var calculated_top_perc = position.n_start_y_perc + (n_nth_obj%position.wrap_after) * (n_margin_y) + n_number_of_wraps * position.n_margin_y_after_wrap;
                        }else{
                            var calculated_left_perc = position.n_start_x_perc + n_nth_obj * (n_margin_x); 
                            var calculated_top_perc = position.n_start_y_perc + n_nth_obj * (n_margin_y);
                        }

                        var n_left_perc = (object.n_left) ? object.n_left : calculated_left_perc;
                        var n_top_perc = (object.n_top) ? object.n_top : calculated_top_perc;
                        var style = `
                            width: ${n_width_perc}%;
                            padding-top: ${n_height_perc}%;
                            left: ${n_left_perc}%; 
                            top: ${n_top_perc}%;
                        `;
                        return style.trim();
                    },
                    get_slider_by_id: function(id){
                        var self = this;
                        var slider = self.akai_apc_mini.sliders.filter(function(asdf){
                            return asdf.id == id; 
                        }); 
                        if(slider.length>0){
                            return slider[0]
                        }
                        return null;
                    },
                    get_object_by_id: function(key){
                        var pad_group = vueObject.akai_apc_mini.pads_groups.filter(function(asdf){
                                
                                var a = asdf.pads.filter(function(asdf2){
                                    return asdf2.id == key; 
                                })

                                return a.length > 0
                            })
                            if(pad_group.length > 0){
                                pad_group = pad_group[0];
                                var pad = pad_group.pads.filter(function(asdf2){
                                    return asdf2.id == key; 
                                });

                                // console.log(key);
                                // console.log(pad);

                                if(pad.length > 0){
                                    return pad[0]; 
                                }
                            }
                        return null;
                    },
                    reset_or_update_history_if_data_change: function(){
                        var self = this;
                        
                        // reset the history if user updated changes 'manually' (without using ctrl+z)

                        if(!self.undo_redo_used){
                            console.log("reset history");
                            self.data_history = self.data_history.slice(0, self.data_history_index+1);
                            self.undo_redo_used = false; 
                        }

                        if(self.data_change){
                            
                            window.setTimeout(function(){

                                self.write_b64_to_history();
                                self.data_change = false; 
    
                            },10);
                        }
                    }, 
                    get_important_data_for_url: function(){

                        let data_copy = Object.assign({}, this._data);
                        for(var key in this.data_to_b64_ignore_props){
                            var prop = this.data_to_b64_ignore_props[key];
                            delete data_copy[prop];
                        }

                        return data_copy;

                    },
                    write_b64_to_history: function(){
                        //for the history we can use full data object , not really working :(
                        var data = this.get_important_data_for_url();
                        var b64_string = this.data_to_b64(data);
                        this.data_history.push(b64_string);
                        this.data_history_index = parseInt(this.data_history.length -1);
                        
                        console.log("write_b64_to_history, history: ");
                        console.log(this.data_history);
                    },
                    write_b64_to_url: function(){
                        var data = this.get_important_data_for_url();
                        var b64_string = this.data_to_b64(data);
                        var parts = window.location.href.split(this.url_b64_separator);
                        var clear_url = parts.shift();
                        // !IMPORTANT , while developing and using write_b64_to_url, data will be loaded between site reloads which leads to unexpected behaviuours !!!, don't ever use write_b64_to_url in development
                        if(!this.development){
                            window.location.href = clear_url + this.url_b64_separator + this.url_b64_prop + this.url_b64_assignment_character + b64_string;
                        }
                    },
                    read_b64_from_url: function(){
                        var parts = window.location.href.split(this.url_b64_separator);
                        var fragment = parts.pop();
                        var parts = fragment.split(this.url_b64_prop + this.url_b64_assignment_character);
                        //console.log(parts);

                        if(parts.length == 1){
                            return false;
                        }
                        var b64_string = parts.pop();
                        var data = this.b64_to_data(b64_string);

                        this.apply_data_copy_to_data(data);
                    },
                    data_to_b64: function(data){

                        var data_copy_json = JSON.stringify(data);
                        
                        var data_copy_json_b64 = btoa((encodeURIComponent(data_copy_json)));

                        return data_copy_json_b64;

                    },
                    b64_to_data : function(b64){
                        var atobed = atob(b64);
                        var data_json = decodeURIComponent(atobed);
                        var data = JSON.parse(data_json);
                        return data; 
                    },
                    apply_data_copy_to_data: function(data){
                        for(var key in data){
                            this[key] = data[key];
                        }
                        return true;
                    }, 
                    
                    "test_method": function(){
                        console.log("test");
                    }, 
                },
                computed: {
                    "test_computed": function(){
                        return "test_computed"
                    }
                }
            })
        
    });



</script>